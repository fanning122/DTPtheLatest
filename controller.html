<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CMGAP提字器 - 遥控器</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            color: white;
            height: 100vh;
            touch-action: none;
            -webkit-overflow-scrolling: touch;
            font-family: -apple-system, "HarmonyOS Sans", BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            overflow: hidden;
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .status-connected {
            background-color: #4CAF50;
        }
        
        .status-disconnected {
            background-color: #f44336;
        }
        
        .debug-info {
            position: fixed;
            bottom: 5px;
            left: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 10px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
            color: #ccc;
            max-width: 200px;
            word-break: break-all;
        }
        
        .remote-display {
            width: 100%;
            height: 100vh;
            background-color: black;
            position: relative;
            overflow: hidden;
        }
        
        .instruction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            font-size: 18px;
            z-index: 1;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .touch-indicator {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
            display: none;
        }
        
        .connection-help {
            position: fixed;
            top: 50px;
            right: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            font-size: 12px;
            max-width: 150px;
        }
    </style>
</head>
<body>
    <div class="connection-status status-disconnected" id="connection-status">
        显示端: 未连接
    </div>
    
    <div class="debug-info" id="debug-info">
        连接状态: 等待连接...
    </div>
    
    <div class="connection-help">
        使用说明:<br>
        • 单击: 暂停并手动控制<br>
        • 双击: 播放/暂停切换<br>
        • 拖动: 滚动文本
    </div>
    
    <div class="remote-display" id="remote-display">
        <div class="instruction" id="instruction">
            触摸此区域控制远程提词器<br>
            <small>单击: 暂停并手动控制 | 双击: 播放/暂停 | 拖动: 滚动</small>
        </div>
        <div class="touch-indicator" id="touch-indicator"></div>
    </div>

    <script>
        // WebSocket连接管理
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // 自动检测服务器地址 - 支持本地和 Heroku 部署
        const isLocal = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1' ||
                        window.location.hostname.includes('192.168.');

        let serverUrl;
        if (isLocal) {
            // 本地开发环境
            const serverHost = window.location.hostname;
            const serverPort = window.location.port || '3000';
            serverUrl = `ws://${serverHost}:${serverPort}?type=controller`;
        } else {
            // 生产环境 - 连接到 Heroku
            serverUrl = `wss://dtp-fab1bc8fc9e9.herokuapp.com?type=controller`;
        }
        
        function connectWebSocket() {
            updateDebugInfo(`尝试连接: ${serverUrl}`);
            
            try {
                ws = new WebSocket(serverUrl);
                
                ws.onopen = () => {
                    console.log('已连接到WebSocket服务器');
                    updateConnectionStatus(true);
                    updateDebugInfo('已连接到服务器');
                    document.getElementById('instruction').style.display = 'none';
                    reconnectAttempts = 0;
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('收到服务器消息:', data);
                        
                        if (data.type === 'welcome') {
                            updateDebugInfo(`服务器: ${data.message}`);
                        } else if (data.type === 'positionUpdate') {
                            // 接收显示端的位置更新
                            lastScrollPosition = data.position || 0;
                            updateDebugInfo(`位置: ${Math.round(lastScrollPosition)}`);
                        }
                    } catch (error) {
                        console.error('解析消息错误:', error);
                    }
                };
                
                ws.onclose = (event) => {
                    console.log('WebSocket连接关闭:', event.code, event.reason);
                    updateConnectionStatus(false);
                    document.getElementById('instruction').style.display = 'block';
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * reconnectAttempts, 5000);
                        updateDebugInfo(`连接断开，${delay/1000}秒后重试...`);
                        setTimeout(connectWebSocket, delay);
                    } else {
                        updateDebugInfo('连接失败，请刷新页面重试');
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    updateConnectionStatus(false);
                    updateDebugInfo('连接错误');
                };
                
            } catch (error) {
                console.error('创建WebSocket失败:', error);
                updateConnectionStatus(false);
                updateDebugInfo('创建连接失败');
            }
        }
        
        function updateConnectionStatus(connected, message = '') {
            const statusElement = document.getElementById('connection-status');
    
            if (connected) {
                statusElement.textContent = '✅ 显示端: 已连接';
                statusElement.style.color = 'green';
                statusElement.style.fontSize = '18px';
                statusElement.style.fontWeight = 'bold';
            } else {
                statusElement.textContent = '❌ 显示端: 未连接 - ' + message;
                statusElement.style.color = 'red';
                statusElement.style.fontSize = '18px';
                statusElement.style.fontWeight = 'bold';
            }
        }
        
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            debugElement.textContent = message;
            console.log('调试信息:', message);
        }
        
        function sendCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    ...command,
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(message));
                updateDebugInfo(`发送: ${command.type}`);
            } else {
                updateDebugInfo('发送失败: 连接未就绪');
            }
        }
        
        // 触摸事件处理 - 修改为相对位移方式
        const remoteDisplay = document.getElementById('remote-display');
        const touchIndicator = document.getElementById('touch-indicator');
        
        let touchStartY = 0;
        let isRemoteTouchMoving = false;
        let remoteTouchCount = 0;
        let lastRemoteTouchTime = 0;
        let lastScrollPosition = 0; // 记录上次的滚动位置
        
        // 触摸开始
        remoteDisplay.addEventListener('touchstart', function(e) {
            const now = Date.now();
            
            // 双击检测（播放/暂停）
            if (now - lastRemoteTouchTime < 300) {
                remoteTouchCount++;
                if (remoteTouchCount === 2) {
                    // 双击：切换播放/暂停状态
                    sendCommand({ type: 'doubleTap' });
                    showTouchIndicator(e.touches[0].clientX, e.touches[0].clientY);
                    e.preventDefault();
                    remoteTouchCount = 0;
                    return;
                }
            } else {
                remoteTouchCount = 1;
            }
            lastRemoteTouchTime = now;
            
            // 单击：暂停滚动并开始手动控制
            sendCommand({ type: 'pause' });
            
            touchStartY = e.touches[0].clientY;
            isRemoteTouchMoving = true;
            
            // 请求显示端发送当前滚动位置
            sendCommand({ type: 'requestPosition' });
            
            showTouchIndicator(e.touches[0].clientX, e.touches[0].clientY);
            e.preventDefault();
        }, { passive: false });
        
        // 触摸移动
        remoteDisplay.addEventListener('touchmove', function(e) {
            if (!isRemoteTouchMoving) return;
            
            const touchY = e.touches[0].clientY;
            const deltaY = touchStartY - touchY; // 计算相对位移（反向）
            
            // 发送相对位移而不是绝对位置
            sendCommand({ 
                type: 'scrollDelta', 
                delta: deltaY * 2 // 乘以2增加灵敏度
            });
            
            // 更新起始位置，以便下次计算相对位移
            touchStartY = touchY;
            
            updateTouchIndicator(e.touches[0].clientX, e.touches[0].clientY);
            e.preventDefault();
        }, { passive: false });
        
        // 触摸结束
        remoteDisplay.addEventListener('touchend', function(e) {
            isRemoteTouchMoving = false;
            hideTouchIndicator();
            setTimeout(() => { remoteTouchCount = 0; }, 300);
            e.preventDefault();
        }, { passive: false });
        
        // 触摸取消
        remoteDisplay.addEventListener('touchcancel', function(e) {
            isRemoteTouchMoving = false;
            hideTouchIndicator();
            e.preventDefault();
        }, { passive: false });
        
        // 触摸指示器函数
        function showTouchIndicator(x, y) {
            touchIndicator.style.left = x + 'px';
            touchIndicator.style.top = y + 'px';
            touchIndicator.style.display = 'block';
        }
        
        function updateTouchIndicator(x, y) {
            touchIndicator.style.left = x + 'px';
            touchIndicator.style.top = y + 'px';
        }
        
        function hideTouchIndicator() {
            touchIndicator.style.display = 'none';
        }
        
        // 初始化
        function init() {
            connectWebSocket();
        }
        
        window.addEventListener('load', init);
    </script>
    <!-- 手机端调试面板 -->
    <div id="mobile-debug" style="
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        max-width: 90%;
        z-index: 10000;
    ">
        <div>状态: <span id="debug-status">等待连接...</span></div>
        <div>消息: <span id="debug-message">-</span></div>
        <div>时间: <span id="debug-time">-</span></div>
    </div>

    <script>
    // 调试信息更新函数
    function updateMobileDebug(status, message) {
        document.getElementById('debug-status').textContent = status;
        document.getElementById('debug-message').textContent = message;
        document.getElementById('debug-time').textContent = new Date().toLocaleTimeString();
    }
    </script>
</body>
</html>