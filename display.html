<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CMGAPæå­—å™¨ - æ˜¾ç¤ºç«¯</title>
    <style>
        :root {
            --harmony-scale: 1;
            --scroll-position: 0px;
        }
        
        body {
            font-family: -apple-system, "HarmonyOS Sans", BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            touch-action: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .header {
            background-color: #333;
            padding: 1px;
            text-align: center;
            flex-shrink: 0;
            height: 20px;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 16px;
            margin: 0;
            line-height: 28px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            padding: 2px;
            background-color: #444;
            gap: 3px;
            flex-wrap: wrap;
            flex-shrink: 0;
            height: auto;
            min-height: 20px;
        }
        
        button {
            padding: 3px 6px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            min-width: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 3px;
            background-color: #555;
            padding: 3px 3px;
            border-radius: 6px;
        }
        
        .teleprompter {
            flex: 1;
            overflow: hidden;
            position: relative;
            background-color: black;
            margin: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            touch-action: none;
        }
        
        .text-container {
            width: 96%;
            height: 96%;
            overflow: hidden;
            position: relative;
        }
        
        #prompter-text {
            font-size: calc(28px * var(--harmony-scale));
            line-height: 1.8;
            color: white;
            position: absolute;
            width: 100%;
            text-align: center;
            transition: transform 0.1s linear;
            user-select: none;
            padding: 15px;
            box-sizing: border-box;
            font-weight: 500;
            will-change: transform;
            white-space: pre-line;
            text-indent: 2em;
            margin: 0;
            top: 0;
            left: 0;
            transform: translateY(var(--scroll-position, 0px));
        }
        
        .text-container.mirror #prompter-text {
            transform: scaleX(-1) translateY(var(--scroll-position, 0px)) !important;
        }
        
        .use-top-positioning {
            transform: none !important;
            top: var(--text-position, 0px) !important;
        }
        
        .text-container.mirror #prompter-text.use-top-positioning {
            transform: scaleX(-1) !important;
            top: var(--text-position, 0px) !important;
        }
        
        textarea {
            width: 96%;
            min-height: 60px;
            height: auto;
            margin: 5px auto;
            display: block;
            padding: 8px;
            font-size: 32px;
            border-radius: 6px;
            border: none;
            flex-shrink: 0;
            -webkit-appearance: none;
            background-color: white;
            color: black;
        }
        
        #file-input {
            display: none;
        }
        
        .connection-status {
            position: fixed;
            top: 5px;
            right: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .status-connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .status-disconnected {
            background-color: #f44336;
            color: white;
        }
        
        .debug-info {
            position: fixed;
            bottom: 5px;
            left: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 10px;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
            color: #ccc;
            max-width: 200px;
            word-break: break-all;
        }
        
        @media screen and (max-width: 360px) {
            #prompter-text {
                font-size: calc(22px * var(--harmony-scale));
            }
            button {
                padding: 8px 12px;
                min-width: 50px;
                font-size: 16px;
            }
        }

        @media screen and (orientation: landscape) {
            .header {
                display: none;
            }
            
            .header h1 {
                font-size: 16px;
                margin: 0;
                line-height: 28px;
            }

            .teleprompter {
                margin: 2px;
                height: calc(100vh - 60px);
                width: 70%;
                margin-left: auto;
                margin-right: auto;
            }
            
            .text-container {
                width: 100%;
                height: 98% !important;
            }
            
            #prompter-text {
                font-size: calc(26px * var(--harmony-scale));
                padding: 10px;
            }
            
            .controls {
                padding: 4px;
                gap: 4px;
            }
            
            .control-group {
                padding: 4px 5px;
            }
            
            button {
                padding: 8px 5px;
                min-width: 30px;
            }
            
            textarea {
                min-height: 50px;
                height: auto;
                margin: 3px auto;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status status-disconnected" id="connection-status">
        é¥æ§å™¨: æœªè¿æ¥
    </div>
    
    <div class="debug-info" id="debug-info">
        è¿æ¥çŠ¶æ€: ç­‰å¾…è¿æ¥...
    </div>
    
    <div class="header">
        <h1>CMGAPæå­—å™¨ - æ˜¾ç¤ºç«¯</h1>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <button id="start-btn">å¼€å§‹</button>
            <button id="pause-btn" disabled>æš‚åœ</button>
            <button id="reset-btn">é‡ç½®</button>
        </div>
        
        <div class="control-group">
            <label for="speed">é€Ÿåº¦:</label>
            <input type="range" id="speed" min="1" max="20" value="5">
            <span id="speed-value">5</span>
        </div>
        
        <div class="control-group">
            <label for="font-size">å­—ä½“:</label>
            <input type="range" id="font-size" min="16" max="48" value="28">
            <span id="font-size-value">28px</span>
        </div>
        
        <div class="control-group">
            <button id="mirror-btn">é•œåƒæ¨¡å¼</button>
            <button id="open-file-btn">æ‰“å¼€æ–‡ä»¶</button>
            <input type="file" id="file-input" accept=".txt,.text,.md,.markdown,.log,.csv,.json,.xml,.html,.htm">
        </div>
    </div>
    
    <div class="teleprompter" id="teleprompter-area">
        <div class="text-container" id="text-container">
            <div id="prompter-text">åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„æ–‡æœ¬ã€‚ç‚¹å‡»"å¼€å§‹"æŒ‰é’®å¼€å§‹æ»šåŠ¨ï¼Œä½¿ç”¨é€Ÿåº¦æ»‘å—è°ƒæ•´æ»šåŠ¨é€Ÿåº¦ã€‚</div>
        </div>
    </div>
    
    <textarea id="input-text" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„æè¯æ–‡æœ¬..."></textarea>
    
    <script>
        // WebSocketè¿æ¥ç®¡ç†
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€ - æ”¯æŒæœ¬åœ°å’Œ Heroku éƒ¨ç½²
        const isLocal = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1' ||
                        window.location.hostname.includes('192.168.');

        let serverUrl;
        if (isLocal) {
            // æœ¬åœ°å¼€å‘ç¯å¢ƒ
            const serverHost = window.location.hostname;
            const serverPort = window.location.port || '3000';
            serverUrl = `ws://${serverHost}:${serverPort}?type=display`;
        } else {
            // ç”Ÿäº§ç¯å¢ƒ - è¿æ¥åˆ° Heroku
            serverUrl = `wss://dtp-fab1bc8fc9e9.herokuapp.com?type=display`;
        }
        
        function connectWebSocket() {
            // ğŸ¯ æ–°å¢è°ƒè¯•ä¿¡æ¯å¼€å§‹
            console.log("=== DISPLAY è¿æ¥è°ƒè¯•ä¿¡æ¯ ===");
            console.log("1. å½“å‰é¡µé¢åœ°å€:", window.location.href);
            console.log("2. ä¸»æœºå:", window.location.hostname);
            console.log("3. æ˜¯å¦æœ¬åœ°ç¯å¢ƒ:", isLocal);
            console.log("4. æœ€ç»ˆè¿æ¥åœ°å€:", serverUrl);
            console.log("=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===");
    
            // åœ¨é¡µé¢ä¸Šä¹Ÿæ˜¾ç¤ºè¿æ¥ä¿¡æ¯ï¼ˆæ‰‹æœºç«¯èƒ½çœ‹åˆ°ï¼‰
            updateDebugInfo(`å°è¯•è¿æ¥åˆ°: ${serverUrl}`);
            // ğŸ¯ æ–°å¢è°ƒè¯•ä¿¡æ¯ç»“æŸ
    
            // ä¸‹é¢æ˜¯ä½ åŸæœ‰çš„ä»£ç 
            updateDebugInfo(`å°è¯•è¿æ¥: ${serverUrl}`);
            
            try {
                ws = new WebSocket(serverUrl);
                
                ws.onopen = () => {
                    console.log('å·²è¿æ¥åˆ°WebSocketæœåŠ¡å™¨');
                    updateConnectionStatus(true);
                    updateDebugInfo('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    reconnectAttempts = 0;
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('æ”¶åˆ°æ§åˆ¶æŒ‡ä»¤:', data);
                        updateDebugInfo(`æ”¶åˆ°æŒ‡ä»¤: ${data.type}`);
                        handleRemoteControl(data);
                    } catch (error) {
                        console.error('è§£ææ§åˆ¶æŒ‡ä»¤é”™è¯¯:', error);
                        updateDebugInfo('è§£ææŒ‡ä»¤é”™è¯¯');
                    }
                };
                
                ws.onclose = (event) => {
                    console.log('WebSocketè¿æ¥æ–­å¼€:', event.code, event.reason);
                    updateConnectionStatus(false);
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * reconnectAttempts, 5000);
                        updateDebugInfo(`è¿æ¥æ–­å¼€ï¼Œ${delay/1000}ç§’åé‡è¯•...`);
                        setTimeout(connectWebSocket, delay);
                    } else {
                        updateDebugInfo('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    updateConnectionStatus(false);
                    updateDebugInfo('è¿æ¥é”™è¯¯');
                };
                
            } catch (error) {
                console.error('åˆ›å»ºWebSocketå¤±è´¥:', error);
                updateConnectionStatus(false);
                updateDebugInfo('åˆ›å»ºè¿æ¥å¤±è´¥');
            }
        }
        
        function updateConnectionStatus(connected, message = '') {
            const statusElement = document.getElementById('connection-status');
    
            if (connected) {
                statusElement.textContent = 'âœ… æœåŠ¡å™¨: å·²è¿æ¥';
                statusElement.style.color = 'green';
                statusElement.style.fontSize = '18px';
                statusElement.style.fontWeight = 'bold';
            } else {
                statusElement.textContent = 'âŒ æœåŠ¡å™¨: æœªè¿æ¥ - ' + message;
                statusElement.style.color = 'red';
                statusElement.style.fontSize = '18px';
                statusElement.style.fontWeight = 'bold';
            }
        }
        
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            debugElement.textContent = message;
            console.log('è°ƒè¯•ä¿¡æ¯:', message);
        }
        
        function handleRemoteControl(data) {
            switch (data.type) {
                case 'scroll':
                    position = data.position;
                    updatePosition();
                    break;
                
                case 'scrollDelta':
                     // å¤„ç†ç›¸å¯¹ä½ç§»
                     position += data.delta;
                     updatePosition();
            
                     // åŒæ­¥å½“å‰ä½ç½®ç»™æ§åˆ¶ç«¯
                     if (ws && ws.readyState === WebSocket.OPEN) {
                         ws.send(JSON.stringify({
                             type: 'positionUpdate',
                             position: position,
                             maxPosition: Math.max(0, textHeight - containerHeight)
                         }));
                     }
                     break;
    
                case 'play':
                    startScrolling();
                    break;
                    
                case 'pause':
                    pauseScrolling();
                    break;
                    
                case 'doubleTap':
                    if (isPlaying) pauseScrolling();
                    else startScrolling();
                    break;
                
                case 'requestPosition':
                    // å“åº”ä½ç½®è¯·æ±‚
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'positionUpdate',
                            position: position,
                            maxPosition: Math.max(0, textHeight - containerHeight)
                        }));
                    }
                    break;
     
                case 'textUpdate':
                    prompterText.textContent = data.text;
                    inputText.value = data.text;
                    setTimeout(calculateHeights, 100);
                    break;
                    
                case 'mirrorToggle':
                    textContainer.classList.toggle('mirror');
                    mirrorBtn.textContent = textContainer.classList.contains('mirror') ? 'æ­£å¸¸æ¨¡å¼' : 'é•œåƒæ¨¡å¼';
                    break;
                    
                case 'welcome':
                    updateDebugInfo(`æœåŠ¡å™¨: ${data.message}`);
                    break;

                case 'positionUpdate':
                     // ä»æ˜¾ç¤ºç«¯æ¥æ”¶ä½ç½®æ›´æ–°ï¼ˆç”¨äºåŒå‘åŒæ­¥ï¼‰
                     if (data.position !== undefined) {
                         lastScrollPosition = data.position;
                     }
                     break;
            }
        }
        
        // åŸæœ‰çš„æ‰€æœ‰JavaScriptä»£ç ä¿æŒä¸å˜
        const systemInfo = {
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
            isAndroid: /Android/.test(navigator.userAgent),
            isHarmonyOS: /HarmonyOS|HMOS/.test(navigator.userAgent),
            isChrome: /Chrome/.test(navigator.userAgent),
            isSafari: /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent),
            browser: navigator.userAgent
        };
        
        const useTopPositioning = systemInfo.isIOS;
        
        if (systemInfo.isHarmonyOS) {
            document.documentElement.style.setProperty('--harmony-scale', '1.1');
        }
        
        if (systemInfo.isIOS) {
            document.body.style.webkitUserSelect = 'none';
            document.body.style.webkitTouchCallout = 'none';
            document.getElementById('prompter-text').classList.add('use-top-positioning');
        }
        
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const mirrorBtn = document.getElementById('mirror-btn');
        const openFileBtn = document.getElementById('open-file-btn');
        const fileInput = document.getElementById('file-input');
        const speedSlider = document.getElementById('speed');
        const speedValue = document.getElementById('speed-value');
        const fontSizeSlider = document.getElementById('font-size');
        const fontSizeValue = document.getElementById('font-size-value');
        const prompterText = document.getElementById('prompter-text');
        const inputText = document.getElementById('input-text');
        const textContainer = document.getElementById('text-container');
        const teleprompterArea = document.getElementById('teleprompter-area');
        
        let isPlaying = false;
        let animationId;
        let position = 0;
        let speed = 5;
        let fontSize = 28;
        let touchStartY = 0;
        let touchStartPosition = 0;
        let isTouchMoving = false;
        let touchCount = 0;
        let lastTouchTime = 0;
        let textHeight = 0;
        let containerHeight = 0;
                
        function calculateHeights() {
            const currentPosition = position;
            
            if (useTopPositioning) {
                prompterText.style.setProperty('--text-position', '0px');
            } else {
                prompterText.style.setProperty('--scroll-position', '0px');
            }
            
            prompterText.offsetHeight;
            
            containerHeight = textContainer.clientHeight;
            textHeight = prompterText.scrollHeight;
            
            updatePosition();
        }
        
        function updatePosition() {
            const maxPosition = Math.max(0, textHeight - containerHeight);
            position = Math.max(0, Math.min(position, maxPosition));
            
            if (useTopPositioning) {
                prompterText.style.setProperty('--text-position', `-${position}px`);
            } else {
                prompterText.style.setProperty('--scroll-position', `-${position}px`);
            }
            
            if (position >= maxPosition && isPlaying) {
                pauseScrolling();
            }
        }
        
        function adjustInitialFontSize() {
            const screenHeight = window.innerHeight;
            if (screenHeight < 600) {
                fontSize = 26;
            } else if (screenHeight > 800) {
                fontSize = 32;
            }
            fontSizeSlider.value = fontSize;
            prompterText.style.fontSize = fontSize + 'px';
            fontSizeValue.textContent = fontSize + 'px';
        }
        
        speedSlider.addEventListener('input', function() {
            speed = parseInt(this.value);
            speedValue.textContent = speed;
        });
        
        fontSizeSlider.addEventListener('input', function() {
            fontSize = parseInt(this.value);
            fontSizeValue.textContent = fontSize + 'px';
            prompterText.style.fontSize = fontSize + 'px';
            setTimeout(calculateHeights, 100);
        });
        
        function startScrolling() {
            if (!isPlaying) {
                isPlaying = true;
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                calculateHeights();
                animate();
            }
        }
        
        function pauseScrolling() {
            if (isPlaying) {
                isPlaying = false;
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                cancelAnimationFrame(animationId);
            }
        }
        
        startBtn.addEventListener('click', startScrolling);
        pauseBtn.addEventListener('click', pauseScrolling);
        
        resetBtn.addEventListener('click', function() {
            pauseScrolling();
            position = 0;
            updatePosition();
        });
        
        mirrorBtn.addEventListener('click', function() {
            textContainer.classList.toggle('mirror');
            
            if (textContainer.classList.contains('mirror')) {
                mirrorBtn.textContent = 'æ­£å¸¸æ¨¡å¼';
            } else {
                mirrorBtn.textContent = 'é•œåƒæ¨¡å¼';
            }
        });
        
        openFileBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                prompterText.textContent = content;
                inputText.value = content;
                setTimeout(calculateHeights, 100);
            };
            reader.onerror = function() {
                alert('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™');
            };
            reader.readAsText(file);
        });
        
        inputText.addEventListener('input', function() {
            prompterText.textContent = this.value || "åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„æ–‡æœ¬ã€‚ç‚¹å‡»\"å¼€å§‹\"æŒ‰é’®å¼€å§‹æ»šåŠ¨ï¼Œä½¿ç”¨é€Ÿåº¦æ»‘å—è°ƒæ•´æ»šåŠ¨é€Ÿåº¦ã€‚";
            setTimeout(calculateHeights, 100);
        });
        
        function animate() {
            position += speed / 10;
            updatePosition();
            
            if (isPlaying) {
                animationId = requestAnimationFrame(animate);
            }
        }
        
        // åŸæœ‰çš„è§¦æ‘¸äº‹ä»¶å¤„ç†ä¿æŒä¸å˜
        teleprompterArea.addEventListener('touchstart', function(e) {
            const now = Date.now();
            
            if (now - lastTouchTime < 300) {
                touchCount++;
                if (touchCount === 2) {
                    if (isPlaying) pauseScrolling();
                    else startScrolling();
                    e.preventDefault();
                    touchCount = 0;
                    return;
                }
            } else {
                touchCount = 1;
            }
            lastTouchTime = now;
            
            if (isPlaying) pauseScrolling();
            
            touchStartY = e.touches[0].clientY;
            touchStartPosition = position;
            isTouchMoving = true;
            e.preventDefault();
        }, { passive: false });
        
        teleprompterArea.addEventListener('touchmove', function(e) {
            if (!isTouchMoving) return;
            
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - touchStartY;
            position = touchStartPosition - deltaY;
            
            updatePosition();
            e.preventDefault();
        }, { passive: false });
        
        teleprompterArea.addEventListener('touchend', function(e) {
            isTouchMoving = false;
            setTimeout(() => { touchCount = 0; }, 300);
            e.preventDefault();
        }, { passive: false });
        
        window.addEventListener('resize', function() {
            setTimeout(calculateHeights, 100);
        });
        
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                calculateHeights();
                updatePosition();
            }, 300);
        });
        
        function init() {
            adjustInitialFontSize();
            textContainer.style.height = '92%';
            setTimeout(calculateHeights, 500);
            connectWebSocket(); // åˆå§‹åŒ–WebSocketè¿æ¥
        }
        
        window.addEventListener('load', init);
    </script>
    <!-- æ‰‹æœºç«¯è°ƒè¯•é¢æ¿ -->
    <div id="mobile-debug" style="
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        max-width: 90%;
        z-index: 10000;
    ">
        <div>çŠ¶æ€: <span id="debug-status">ç­‰å¾…è¿æ¥...</span></div>
        <div>æ¶ˆæ¯: <span id="debug-message">-</span></div>
        <div>æ—¶é—´: <span id="debug-time">-</span></div>
    </div>

    <script>
    // è°ƒè¯•ä¿¡æ¯æ›´æ–°å‡½æ•°
    function updateMobileDebug(status, message) {
        document.getElementById('debug-status').textContent = status;
        document.getElementById('debug-message').textContent = message;
        document.getElementById('debug-time').textContent = new Date().toLocaleTimeString();
    }
    </script>
</body>
</html>